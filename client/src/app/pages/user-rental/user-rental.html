<main class="main-content">
  <div class="page-header">
    <h2>Chuyến của tôi ({{ rentals.length }})</h2>
  </div>
  <div class="rental-tabs">
    <button class="tab-btn" [class.active]="activeTab === 'current'" (click)="switchTab('current')">
      <i class="bi bi-hourglass-split"></i>
      Chuyến hiện tại ({{ currentRentals.length }})
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'history'" (click)="switchTab('history')">
      <i class="bi bi-clock-history"></i>
      Lịch sử chuyến ({{ historyRentals.length }})
    </button>
  </div>

  <!-- Bộ lọc cho lịch sử chuyến -->
  <div class="chip-row" *ngIf="activeTab === 'history'">
    <!-- Lọc theo trạng thái -->
    <div class="dropdown" (click)="$event.stopPropagation()">
      <button class="btn-chip" [class.selected]="selectedStatusFilter !== 'all'" (click)="toggleDropdown('status')">
        <i class="bi bi-funnel"></i>
        Trạng thái: {{ getStatusFilterText() }}
      </button>
      <div class="menu" *ngIf="openDropdown === 'status'">
        <button class="dropdown-item" [class.active]="selectedStatusFilter === 'all'"
                (click)="selectStatusFilter('all')">Tất cả</button>
        <button class="dropdown-item" [class.active]="selectedStatusFilter === 'completed'"
                (click)="selectStatusFilter('completed')">Hoàn thành</button>
        <button class="dropdown-item" [class.active]="selectedStatusFilter === 'cancelled'"
                (click)="selectStatusFilter('cancelled')">Đã hủy</button>
        <button class="dropdown-item" [class.active]="selectedStatusFilter === 'rejected'"
                (click)="selectStatusFilter('rejected')">Bị từ chối</button>
      </div>
    </div>

    <!-- Lọc theo thời gian -->
    <div class="dropdown" (click)="$event.stopPropagation()">
      <button class="btn-chip" [class.selected]="selectedTimeFilter !== 'all'" (click)="toggleDropdown('time')">
        <i class="bi bi-calendar-range"></i>
        Thời gian: {{ getTimeFilterText() }}
      </button>
      <div class="menu" *ngIf="openDropdown === 'time'">
        <button class="dropdown-item" [class.active]="selectedTimeFilter === 'all'"
                (click)="selectTimeFilter('all')">Tất cả</button>
        <button class="dropdown-item" [class.active]="selectedTimeFilter === 'thisMonth'"
                (click)="selectTimeFilter('thisMonth')">Tháng này</button>
        <button class="dropdown-item" [class.active]="selectedTimeFilter === 'lastMonth'"
                (click)="selectTimeFilter('lastMonth')">Tháng trước</button>
        <button class="dropdown-item" [class.active]="selectedTimeFilter === 'last3Months'"
                (click)="selectTimeFilter('last3Months')">3 tháng qua</button>
        <button class="dropdown-item" [class.active]="selectedTimeFilter === 'thisYear'"
                (click)="selectTimeFilter('thisYear')">Năm nay</button>
      </div>
    </div>

    <!-- Lọc theo giá -->
    <div class="dropdown" (click)="$event.stopPropagation()">
      <button class="btn-chip" [class.selected]="selectedPriceFilter !== 'all'" (click)="toggleDropdown('price')">
        <i class="bi bi-currency-dollar"></i>
        Giá: {{ getPriceFilterText() }}
      </button>
      <div class="menu" *ngIf="openDropdown === 'price'">
        <button class="dropdown-item" [class.active]="selectedPriceFilter === 'all'"
                (click)="selectPriceFilter('all')">Tất cả</button>
        <button class="dropdown-item" [class.active]="selectedPriceFilter === 'under1M'"
                (click)="selectPriceFilter('under1M')">Dưới 1 triệu</button>
        <button class="dropdown-item" [class.active]="selectedPriceFilter === '1M_3M'"
                (click)="selectPriceFilter('1M_3M')">1 - 3 triệu</button>
        <button class="dropdown-item" [class.active]="selectedPriceFilter === '3M_5M'"
                (click)="selectPriceFilter('3M_5M')">3 - 5 triệu</button>
        <button class="dropdown-item" [class.active]="selectedPriceFilter === 'over5M'"
                (click)="selectPriceFilter('over5M')">Trên 5 triệu</button>
      </div>
    </div>
  </div>

  <div class="alert alert-warning" *ngIf="!loading && filteredRentals.length === 0">
    <span *ngIf="activeTab === 'current'">Bạn chưa có chuyến đi hiện tại nào.</span>
    <span *ngIf="activeTab === 'history'">Bạn chưa có lịch sử chuyến đi nào.</span>
  </div>

  <div class="cards-list" *ngIf="!loading && filteredRentals.length > 0">
    <div *ngFor="let rental of paginatedRentals" class="car-card">
      <div class="car-avatar">
        <div class="thumb">
          <ng-container *ngIf="rental.car_details.Anh_xe && rental.car_details.Anh_xe.length > 0">
            <img [src]="rental.car_details.Anh_xe[0]" [alt]="rental.car_details.Dong_xe"
              onerror="this.src='assets/images/placeholder.webp'">
          </ng-container>
          <img *ngIf="!rental.car_details.Anh_xe || rental.car_details.Anh_xe.length === 0"
            src="assets/images/placeholder.webp" alt="No car image">
        </div>
      </div>
      <div class="car-details">
        <div>
          <h3 class="car-name">{{ rental.car_details.Hang_xe }} {{ rental.car_details.Dong_xe }} {{
            rental.car_details.Nam_san_xuat
            }}</h3>
        </div>
        <div class="info-grid">
          <div class="info-row" *ngIf="rental.Ma_vi_tri_nhan != null">
            <div class="info-label">
              <i class="bi bi-geo-alt"></i>
              <span>Vị trí nhận:</span>
            </div>
            <div class="info-value">{{ getLocationAddress(rental.Ma_vi_tri_nhan) }}</div>
          </div>

          <div class="info-row" *ngIf="rental.Ma_vi_tri_tra != null">
            <div class="info-label">
              <i class="bi bi-geo-alt"></i>
              <span>Vị trí trả:</span>
            </div>
            <div class="info-value">{{ getLocationAddress(rental.Ma_vi_tri_tra) }}</div>
          </div>

          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-calendar-check"></i>
              <span>Ngày nhận:</span>
            </div>
            <div class="info-value">{{ formatDate(rental.Ngay_nhan_xe) }} {{ rental.Gio_nhan_xe }}</div>
          </div>

          <div class="info-row">
            <div class="info-label">
              <i class="bi bi-calendar-x"></i>
              <span>Ngày trả:</span>
            </div>
            <div class="info-value">{{ formatDate(rental.Ngay_tra_xe) }} {{ rental.Gio_tra_xe }}</div>
          </div>
        </div>


        <!-- Giá -->
        <div class="price-row">
          <div class="price fs-4">
            {{vnd(rental.Tong_chi_phi)}} VNĐ
          </div>
        </div>

        <span class=" status-badge rental-status" [ngClass]="getStatusClass(rental.Trang_thai)">
          {{ getStatusText(rental.Trang_thai) }}

        </span>
        <!-- <div class="rental-date text-muted">
                  Ngày trả: 
                    <span class="">{{formatDate(rental.Ngay_tra_xe)}} {{rental.Gio_tra_xe}}</span>
                </div> -->
      </div>
      <div class="rental-actions">
        <span class=" status-badge rental-status" [ngClass]="getStatusClass(rental.Trang_thai)">
          {{ getStatusText(rental.Trang_thai) }}
        </span>
        <ng-container *ngIf="activeTab === 'current'">
          <button *ngIf="rental.Trang_thai === 1" class="btn btn-outline-danger">
            <i class="bi bi-x-circle"></i> Hủy đặt xe
          </button>
          <button *ngIf="rental.Trang_thai === 3" class="btn btn-solid-primary">
            <i class="bi bi-check-circle"></i> Xác nhận trả xe
          </button>
          <button *ngIf="rental.Trang_thai === 2 || rental.Trang_thai === 3" class="btn btn-approve">
            <i class="bi bi-clock-history"></i> Gia hạn thuê
          </button>
        </ng-container>
        <ng-container *ngIf="activeTab === 'history'">
          <button *ngIf="rental.Trang_thai === 4" class="btn btn-solid-primary" (click)="rentAgain(rental)">
            <i class="bi bi-arrow-repeat"></i> Thuê lại
          </button>
          <button *ngIf="rental.Trang_thai === 4" class="btn btn-approve" (click)="openReviewModal(rental)">
            <i class="bi bi-star"></i> Đánh giá
          </button>
          <button *ngIf="rental.Trang_thai === 4" class="btn btn-outline-danger" (click)="openComplaintModal(rental)">
            <i class="bi bi-exclamation-circle"></i> Khiếu nại
          </button>
        </ng-container>
      </div>
    </div>
  </div>
  <!-- <!Pagination -->
  <nav aria-label="Page navigation" class="d-flex justify-content-end mt-3" *ngIf="totalPages > 1">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="changePage(currentPage - 1)" href="javascript:void(0)" aria-label="Previous">
          <i class="bi bi-chevron-left"></i>
        </a>
      </li>
      <li *ngFor="let page of [].constructor(totalPages); let i = index" class="page-item"
        [class.active]="(i + 1) === currentPage">
        <a class="page-link" (click)="changePage(i + 1)" href="javascript:void(0)">
          {{ i + 1 }}
        </a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" (click)="changePage(currentPage + 1)" href="javascript:void(0)" aria-label="Next">
          <i class="bi bi-chevron-right"></i>
        </a>
      </li>
    </ul>
  </nav>
</main>

<!-- Modal Components -->
<app-review-modal [show]="showReviewModal" [selectedRental]="selectedRental" (closeModal)="showReviewModal = false"
  (submitReview)="handleReviewSubmit($event)">
</app-review-modal>

<app-complaint-modal [show]="showComplaintModal" [selectedRental]="selectedRental"
  (closeModal)="showComplaintModal = false" (submitComplaint)="handleComplaintSubmit($event)">
</app-complaint-modal>