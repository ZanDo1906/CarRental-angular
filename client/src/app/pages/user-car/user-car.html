<main class="main-content">

  <!-- Header với tiêu đề và nút đăng ký xe mới -->
  <div class="page-header">
    <h2>Xe của tôi ({{ users().length }})</h2>
    <button class="btn btn-register-car" (click)="openRegisterCarModal()">
      <i class="bi bi-plus-circle"></i>
      Đăng ký xe mới
    </button>
  </div>
        
          
          
    <div class="cards-list" *ngIf="!loading && cars.length > 0">

            <div *ngFor="let car of displayedCars()" class="car-card">

              <div class="car-avatar">
                <div class="thumb">
                  <img
                    [src]="(car && car.Anh_xe && car.Anh_xe.length) ? car.Anh_xe[0] : 'assets/images/placeholder.webp'"
                    alt="">
                </div>
              </div>

              <div class="car-details">
                <div>
                  <h3 class="car-name">{{car.Hang_xe}} {{car.Dong_xe}} {{car.Nam_san_xuat}}</h3>
                </div>
                <div class="spec-grid">
                  <div class="spec">
                    <i class="bi bi-gear"></i>
                    <span>{{car.Hop_so}}</span>
                  </div>
                  <div class="spec">
                    <i class="bi bi-people"></i>
                    <span>{{car.So_cho}} chỗ</span>
                  </div>
                  <div class="spec">
                    <i class="bi bi-fuel-pump"></i>
                    <span>{{car.Nhien_lieu}}</span>
                  </div>
                </div>

                <!-- Địa điểm (resolve Ma_vi_tri → địa chỉ từ location.json) -->
                <!-- <div class="loc-row" *ngIf="car.Ma_vi_tri != null">
                  <i class="bi bi-geo-alt"></i>
                  <span>{{ getLocationAddress(car.Ma_vi_tri) }}</span>
                </div> -->

                <hr>

                <!-- Điểm & số chuyến -->
                <div class="meta-row">
                  <div class="meta">
                    <i class="bi bi-star-fill text-warning"></i>
                    <span>{{car.Diem_danh_gia || '5.0'}}</span>
                  </div>
                  <div class="meta">
                    <i class="bi bi-graph-up"></i>
                    <span>{{car.So_chuyen || car.So_luot_thue || 0}} chuyến</span>
                  </div>
                </div>

                <!-- Giá -->
                <div class="price-row">
                  <div class="price fs-4">
                    {{vnd(car.Gia_thue)}} VNĐ/Ngày
                  </div>
                </div>
                <div class="car-status">Đang cho thuê</div>
              </div>
              <div class="car-actions">
                <p class="car-status">Đang cho thuê</p>
                <button (click)="onAction('view', car)" class="btn btn-solid-primary">Cập nhật thông tin</button>
                <button (click)="onAction('approve', car)" class="btn btn-approve">Lịch cho thuê</button>
                <button (click)="onAction('reject', car)" class="btn btn-outline-danger">Dừng cho thuê</button>
              </div>
            </div>
            <!-- Thân card -->
            <!-- <div class="card-body">
              <h3 class="car-name fw-bold fs-4">{{car.Hang_xe}} {{car.Dong_xe}} {{car.Nam_san_xuat}}</h3> -->

            <!-- Hàng 3 thông số -->
            <!-- <div class="spec-grid">
                <div class="spec">
                  <i class="bi bi-gear"></i>
                  <span>{{car.Hop_so}}</span>
                </div>
                <div class="spec">
                  <i class="bi bi-people"></i>
                  <span>{{car.So_cho}} chỗ</span>
                </div>
                <div class="spec">
                  <i class="bi bi-fuel-pump"></i>
                  <span>{{car.Nhien_lieu}}</span>
                </div>
              </div> -->

            <!-- Địa điểm (resolve Ma_vi_tri → địa chỉ từ location.json) -->
            <!-- <div class="loc-row" *ngIf="car.Ma_vi_tri != null">
                <i class="bi bi-geo-alt"></i>
                <span>{{ getLocationAddress(car.Ma_vi_tri) }}</span>
              </div> -->



          </div>

          <nav aria-label="Page navigation" class="d-flex justify-content-end mt-3" *ngIf="totalPages() > 1">
            <ul class="pagination">

              <li class="page-item" [class.disabled]="currentPage === 1">
                <a class="page-link" (click)="prevPage()" href="javascript:void(0)" aria-label="Previous">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>

              <li *ngFor="let page of totalPagesArray()" class="page-item" [class.active]="page === currentPage">
                <a class="page-link" (click)="goToPage(page)" href="javascript:void(0)">
                  {{ page }}
                </a>
              </li>

              <li class="page-item" [class.disabled]="currentPage === totalPages()">
                <a class="page-link" (click)="nextPage()" href="javascript:void(0)" aria-label="Next">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>

          </ul>
        </nav>

  <div *ngIf="users().length === 0" class="alert alert-info mt-3">Không có xe nào để hiển thị cho người dùng này.
  </div>

</main>

<!-- Modal cập nhật thông tin xe -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cập nhật thông tin xe</h3>
      <button type="button" class="close-btn" (click)="closeModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="editingCar">
      <form>
        <!-- Hình ảnh xe -->
        <div class="row mb-4">
          <div class="col-12">
            <h5><i class="bi bi-camera"></i> Hình ảnh xe</h5>
            <div class="car-images-section">
              <div class="current-images" *ngIf="editingCar.Anh_xe && editingCar.Anh_xe.length > 0">
                <div class="image-grid">
                  <div *ngFor="let image of editingCar.Anh_xe; let i = index" class="image-item">
                    <img [src]="image" [alt]="'Ảnh xe ' + (i + 1)" class="car-image-preview">
                    <button type="button" class="btn-remove-image" (click)="removeImage(i)" title="Xóa ảnh">
                      <i class="bi bi-x-circle-fill"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <div class="upload-section mt-3">
                <input type="file" #fileInput (change)="onImageSelected($event)" accept="image/*" multiple style="display: none;">
                <button type="button" class="btn btn-outline-primary" (click)="fileInput.click()">
                  <i class="bi bi-plus-circle"></i> Thêm hình ảnh
                </button>
                <small class="form-text text-muted d-block mt-1">
                  Chọn nhiều ảnh (JPG, PNG). Ảnh đầu tiên sẽ là ảnh đại diện.
                </small>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <!-- Cột trái - Thông tin cơ bản (KHÔNG CHỈNH SỬA ĐƯỢC) -->
          <div class="col-md-6">
            <h5><i class="bi bi-info-circle"></i> Thông tin cơ bản (Không thể chỉnh sửa)</h5>
            
            <div class="form-group">
              <label>Hãng xe</label>
              <input type="text" class="form-control" [value]="editingCar.Hang_xe" readonly disabled>
            </div>
            
            <div class="form-group">
              <label>Dòng xe</label>
              <input type="text" class="form-control" [value]="editingCar.Dong_xe" readonly disabled>
            </div>
            
            <div class="form-group">
              <label>Năm sản xuất</label>
              <input type="number" class="form-control" [value]="editingCar.Nam_san_xuat" readonly disabled>
            </div>
            
            <div class="form-group">
              <label>Biển số xe</label>
              <input type="text" class="form-control" [value]="editingCar.Bien_so_xe" readonly disabled>
            </div>
            
            <div class="form-group">
              <label>Màu sắc</label>
              <input type="text" class="form-control" [value]="editingCar.Mau_sac" readonly disabled>
            </div>

            <div class="form-group">
              <label>Số chỗ ngồi</label>
              <input type="text" class="form-control" [value]="editingCar.So_cho + ' chỗ'" readonly disabled>
            </div>
            
            <div class="form-group">
              <label>Nhiên liệu</label>
              <input type="text" class="form-control" [value]="editingCar.Nhien_lieu" readonly disabled>
            </div>
            
            <div class="form-group">
              <label>Hộp số</label>
              <input type="text" class="form-control" [value]="editingCar.Hop_so" readonly disabled>
            </div>

            <div class="form-group">
              <label>Điểm đánh giá (Hệ thống tự động tính)</label>
              <input type="text" class="form-control" [value]="(editingCar.Diem_danh_gia || 5.0) + '/5.0'" readonly disabled>
            </div>
          </div>
          
          <!-- Cột phải - Thông tin có thể chỉnh sửa -->
          <div class="col-md-6">
            <h5><i class="bi bi-pencil-square"></i> Thông tin có thể chỉnh sửa</h5>
            
            <div class="form-group">
              <label>Giá thuê (VNĐ/ngày) *</label>
              <input type="number" class="form-control editable-field" [(ngModel)]="editingCar.Gia_thue" name="gia_thue" min="50000" max="10000000" required
                placeholder="Ví dụ: 500000">
              <small class="form-text text-muted">Hiện tại: {{ vnd(editingCar.Gia_thue) }} VNĐ</small>
            </div>

            <div class="form-group">
              <label>Số km đã đi</label>
              <input type="number" class="form-control editable-field" [(ngModel)]="editingCar.So_km" name="so_km" min="0" max="999999"
                placeholder="Nhập số km hiện tại">
              <small class="form-text text-muted">Km hiện tại của xe</small>
            </div>

            <div class="form-group">
              <label>Mức tiêu thụ (L/100km)</label>
              <input type="number" class="form-control editable-field" [(ngModel)]="editingCar.Muc_tieu_thu" name="muc_tieu_thu" 
                min="0" max="50" step="0.1" placeholder="Ví dụ: 7.5">
              <small class="form-text text-muted">Mức tiêu thụ nhiên liệu trung bình</small>
            </div>

            <div class="form-group">
              <label>Mô tả chi tiết</label>
              <textarea class="form-control editable-field" [(ngModel)]="editingCar.Mo_ta" name="mo_ta" rows="8" 
                placeholder="Mô tả chi tiết về xe: tình trạng, tính năng đặc biệt, lưu ý sử dụng..."></textarea>
              <small class="form-text text-muted">Mô tả để khách hàng hiểu rõ hơn về xe</small>
            </div>
          </div>
        </div>
        
        <!-- Mô tả -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="form-group">
              <label>Mô tả chi tiết</label>
              <textarea class="form-control" [(ngModel)]="editingCar.Mo_ta" name="mo_ta" rows="4" 
                placeholder="Nhập mô tả chi tiết về xe..."></textarea>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Hủy</button>
      <button type="button" class="btn btn-primary" (click)="saveCar()">Lưu thay đổi</button>
    </div>
  </div>
</div>

<!-- Calendar Modal Component -->
<app-calendar-modal
  [show]="showCalendarModal"
  [selectedCar]="selectedCar"
  (closeModal)="closeCalendarModal()"
  (dayClicked)="onDayClick($event)"
  (blockedDateRemoved)="handleBlockedDateRemoval($event)">
</app-calendar-modal>

<!-- Block Date Modal Component -->
<app-block-date-modal
  [show]="showBlockModal"
  [blockStartDate]="blockStartDate"
  [blockEndDate]="blockEndDate"
  [blockReason]="blockReason"
  (closeModal)="closeBlockModal()"
  (confirm)="confirmBlockDates()"
  (startDateChange)="blockStartDate = $event"
  (endDateChange)="blockEndDate = $event"
  (reasonChange)="blockReason = $event">
</app-block-date-modal>