<main class="main-content">
  <div class="page-header">
    <h2>Xe của tôi ({{ users().length }})</h2>
    <button class="btn btn-register-car" (click)="openRegisterCarModal()">
      <i class="bi bi-plus-circle"></i>
      Đăng ký xe mới
    </button>
  </div>
  <div class="cards-list" *ngIf="!loading && cars.length > 0">
    <div *ngFor="let car of displayedCars()" class="car-card">
      <div class="car-avatar">
        <div class="thumb">
          <img [src]="(car && car.Anh_xe && car.Anh_xe.length) ? car.Anh_xe[0] : 'assets/images/placeholder.webp'"
            alt="">
        </div>
      </div>
      <div class="car-details">
        <div>
          <h3 class="car-name">{{car.Hang_xe}} {{car.Dong_xe}} {{car.Nam_san_xuat}}</h3>
        </div>
        <div class="meta-row">
          <div class="meta">
            <i class="bi bi-gear"></i>
            <span>{{car.Hop_so}}</span>
          </div>
          <div class="meta">
            <i class="bi bi-people"></i>
            <span>{{car.So_cho}} chỗ</span>
          </div>
          <div class="meta">
            <i class="bi bi-fuel-pump"></i>
            <span>{{car.Nhien_lieu}}</span>
          </div>
        </div>

        <!-- Địa điểm (resolve Ma_vi_tri → địa chỉ từ location.json) -->
        <!-- <div class="loc-row" *ngIf="car.Ma_vi_tri != null">
                  <i class="bi bi-geo-alt"></i>
                  <span>{{ getLocationAddress(car.Ma_vi_tri) }}</span>
                </div> -->



        <!-- Điểm & số chuyến -->
        <div class="meta-row">
          <div class="meta">
            <i class="bi bi-star-fill text-warning"></i>
            <span>{{car.Diem_danh_gia || '5.0'}}</span>
          </div>
          <div class="meta">
            <i class="bi bi-graph-up"></i>
            <span>{{car.So_chuyen || car.So_luot_thue || 0}} chuyến</span>
          </div>
        </div>

        <!-- Giá -->
        <div class="price-row">
          <div class="price fs-4">
            {{vnd(car.Gia_thue)}} VNĐ/Ngày
          </div>
        </div>
        <div class="car-status" [class.status-stopped]="car.Tinh_trang_xe === 'stopped'">
          {{ car.Tinh_trang_xe === 'stopped' ? 'Đã dừng cho thuê' : 'Đang cho thuê' }}
        </div>
      </div>
      <div class="car-actions">
        <p class="car-status" [class.status-stopped]="car.Tinh_trang_xe === 'stopped'">
          {{ car.Tinh_trang_xe === 'stopped' ? 'Đã dừng cho thuê' : 'Đang cho thuê' }}
        </p>
        <button (click)="onAction('view', car)" class="btn btn-solid-primary">Cập nhật thông tin</button>
        <button (click)="onAction('approve', car)" class="btn btn-approve">Lịch cho thuê</button>
        <button (click)="onAction('reject', car)" class="btn"
          [class.btn-outline-danger]="car.Tinh_trang_xe !== 'stopped'"
          [class.btn-outline-success]="car.Tinh_trang_xe === 'stopped'">
          {{ car.Tinh_trang_xe === 'stopped' ? 'Tiếp tục cho thuê' : 'Dừng cho thuê' }}
        </button>
      </div>
    </div>
  </div>

  <nav aria-label="Page navigation" class="d-flex justify-content-end mt-3" *ngIf="totalPages() > 1">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="prevPage()" href="javascript:void(0)" aria-label="Previous">
          <i class="bi bi-chevron-left"></i>
        </a>
      </li>

      <li *ngFor="let page of totalPagesArray()" class="page-item" [class.active]="page === currentPage">
        <a class="page-link" (click)="goToPage(page)" href="javascript:void(0)">
          {{ page }}
        </a>
      </li>

      <li class="page-item" [class.disabled]="currentPage === totalPages()">
        <a class="page-link" (click)="nextPage()" href="javascript:void(0)" aria-label="Next">
          <i class="bi bi-chevron-right"></i>
        </a>
      </li>

    </ul>
  </nav>

  <div *ngIf="users().length === 0" class="alert alert-info mt-3">Không có xe nào để hiển thị cho người dùng này.
  </div>

</main>

<!-- Car Edit Modal Component -->
<app-car-edit-modal [show]="showModal" [editingCar]="editingCar" (closeModal)="closeModal()" (saveCar)="saveCar()"
  (cancelEdit)="cancelEdit()" (imageSelected)="onImageSelected($event)" (imageRemoved)="removeImage($event)">
</app-car-edit-modal>

<!-- Calendar Modal Component -->
<app-calendar-modal [show]="showCalendarModal" [selectedCar]="selectedCar" (closeModal)="closeCalendarModal()"
  (dayClicked)="onDayClick($event)" (blockedDateRemoved)="handleBlockedDateRemoval($event)">
</app-calendar-modal>

<!-- Block Date Modal Component -->
<app-block-date-modal [show]="showBlockModal" [blockStartDate]="blockStartDate" [blockEndDate]="blockEndDate"
  [blockReason]="blockReason" (closeModal)="closeBlockModal()" (confirm)="confirmBlockDates()"
  (startDateChange)="blockStartDate = $event" (endDateChange)="blockEndDate = $event"
  (reasonChange)="blockReason = $event">
</app-block-date-modal>