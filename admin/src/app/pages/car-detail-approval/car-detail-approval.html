<div class="tc-container" *ngIf="car; else loading">
  <button (click)="goBack()" class="btn-icon-round btn-outline">
    <i class="bi bi-chevron-left"></i>
  </button>
  <div class="main-container">

    <div class="gallery-section">
      <div class="main-image" (click)="openLightbox(0)">
        <img [src]="car?.Anh_xe?.[0] || 'assets/images/placeholder.webp'" [alt]="car.Hang_xe + ' ' + car.Dong_xe">
      </div>
      <div class="thumbnail-grid">
        <img *ngFor="let img of car?.Anh_xe?.slice(1, 4); let i = index" [src]="img" [alt]="car.Hang_xe"
          (click)="openLightbox(i + 1)">
      </div>
    </div>

    <!-- Main Content Grid: 2 columns (Info + Price Card) -->
    <div class="detail-layout">

      <!-- Left Column: Car Info -->
      <div class="info-section">
        <!-- Header -->
        <div class="car-header">
          <div class="title-row">
            <h1 class="car-title">{{car.Hang_xe}} {{car.Dong_xe}}</h1>
            <div class="actions-icons">
              <button class="icon-btn"><i class="bi bi-share"></i></button>
              <button class="icon-btn"><i class="bi bi-heart"></i></button>
            </div>
          </div>
          <div class="rating-row">
            <span class="rating">
              <i class="bi bi-star-fill"></i>
              {{car.Diem_danh_gia || 5.0}}
            </span>
            <span class="dot">•</span>
            <span class="trips">
              <i class="bi bi-graph-up"></i>
              {{car.So_luot_thue || 0}} chuyến
            </span>
          </div>
        </div>

        <!-- Owner card (clickable -> account detail) -->
                <div class="owner-card" *ngIf="owner">
                    <a class="owner-link" (click)="openOwnerDetail(owner.Ma_nguoi_dung)">
                        <img [src]="owner?.Anh_dai_dien || 'assets/images/user_avt.jpg'" alt="avatar"
                            class="owner-avatar" />
                        <div class="owner-meta">
                            <div class="owner-name">{{ owner?.Ho_va_ten }}</div>
                            <div class="owner-contact">{{ owner?.So_dien_thoai }} • {{ owner?.Email }}</div>
                        </div>
                    </a>
                </div>

        <!-- Đặc điểm -->
        <div class="features-section">
          <h3 class="section-title">Đặc điểm</h3>
          <div class="features-grid">
            <div class="feature-item">
              <i class="bi bi-diagram-3"></i>
              <div class="feature-content">
                <div class="feature-label">Số ghế</div>
                <div class="feature-value">{{car.So_cho}} chỗ</div>
              </div>
            </div>
            <div class="feature-item">
              <i class="bi bi-palette"></i>
              <div class="feature-content">
                <div class="feature-label">Màu xe</div>
                <div class="feature-value">{{car.Mau_sac || 'Đen'}}</div>
              </div>
            </div>
            <div class="feature-item">
              <i class="bi bi-gear"></i>
              <div class="feature-content">
                <div class="feature-label">Truyền động</div>
                <div class="feature-value">{{car.Hop_so}}</div>
              </div>
            </div>
            <div class="feature-item">
              <i class="bi bi-ev-front"></i>
              <div class="feature-content">
                <div class="feature-label">Dòng xe</div>
                <div class="feature-value">{{car.Loai_xe || 'Sedan'}}</div>
              </div>
            </div>
            <div class="feature-item">
              <i class="bi bi-fuel-pump"></i>
              <div class="feature-content">
                <div class="feature-label">Nhiên liệu</div>
                <div class="feature-value">{{car.Nhien_lieu}}</div>
              </div>
            </div>
            <div class="feature-item">
              <i class="bi bi-speedometer2"></i>
              <div class="feature-content">
                <div class="feature-label">Mức tiêu thụ</div>
                <div class="feature-value">{{car.Muc_tieu_thu || '6.5'}} lít/100km</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mô tả -->
        <div class="description-section">
          <h3 class="section-title">Mô tả</h3>
          <p class="description-text">{{car.Mo_ta || 'Xe trong tình trạng tốt, bảo dưỡng định kỳ.'}}</p>
        </div>

        <!-- Các tiện nghi khác -->
        <div class="amenities-section">
          <h3 class="section-title">Các tiện nghi khác</h3>
          <div class="amenities-list">
            <div class="amenity-item">
              <i class="bi bi-camera-video"></i>
              <span>Camera hành trình</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-geo-alt"></i>
              <span>Định vị GPS</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-usb-symbol"></i>
              <span>Khe cắm USB</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-disc"></i>
              <span>Lốp dự phòng</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-bluetooth"></i>
              <span>Bluetooth</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-droplet"></i>
              <span>Cảm biến lốp</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-badge-4k"></i>
              <span>Camera 360</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-laptop"></i>
              <span>ETC</span>
            </div>
            <div class="amenity-item">
              <i class="bi bi-map"></i>
              <span>Bản đồ</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Right Column: Booking Card -->
      <div class="booking-card">
        <div class="booking-header">
          <h2 class="booking-price">{{vnd(car.Gia_thue)}}<span> vnđ/Ngày</span></h2>
        </div>

        <!-- Các chi phí khác -->
        <div class="other-fees">
          <h4 class="section-label">Các chi phí khác</h4>
          <div class="fee-item">
            <span class="fee-label">Phụ phí xăng:</span>
            <span class="fee-value">30.000 vnd/lít</span>
          </div>
          <p class="fee-note">Trustcar chi trả khi vạch xăng thấp hơn lúc nhận xe. Trả lại cùng vạch xăng như lúc nhận
            xe thì không phải trả phí này.</p>
          <div class="fee-item">
            <span class="fee-label">Phí vệ sinh:</span>
            <span class="fee-value">120.000 vnd - 150.000 vnd</span>
          </div>
          <p class="fee-note">Vui lòng trả lại xe trong trạng thái vệ sinh như lúc nhận xe để không mất phí này.</p>
        </div>
        <div class="button">
          <button (click)="onAction('approve', car)" class="btn btn-solid-approve">Duyệt</button>
          <button (click)="onAction('reject', car)" class="btn btn-danger">Từ chối</button>
        </div>
      </div>


      <!-- End detail-layout -->

    </div>

  </div>


</div>

<div class="lightbox-overlay" *ngIf="showLightbox" (click)="closeLightbox()">
  <button class="lightbox-close" (click)="closeLightbox()">
    <i class="bi bi-x-lg"></i>
  </button>

  <button class="lightbox-prev" (click)="prevImage($event)" *ngIf="car?.Anh_xe?.length > 1">
    <i class="bi bi-chevron-left"></i>
  </button>

  <div class="lightbox-content" (click)="$event.stopPropagation()">
    <img [src]="car?.Anh_xe?.[currentImageIndex]" [alt]="car.Hang_xe + ' ' + car.Dong_xe">
    <div class="lightbox-counter">{{currentImageIndex + 1}} / {{car?.Anh_xe?.length}}</div>
  </div>

  <button class="lightbox-next" (click)="nextImage($event)" *ngIf="car?.Anh_xe?.length > 1">
    <i class="bi bi-chevron-right"></i>
  </button>
</div>

<ng-template #loading>
  <div class="container">
    <p class="text-center py-5">Đang tải chi tiết xe…</p>
  </div>
</ng-template>

<div class="modal-overlay" *ngIf="modalType()">
  <div class="modal-content">

    <button class="modal-close" (click)="closeModal()">
      <i class="bi bi-x"></i> </button>

    <div [ngSwitch]="modalType()">

      <div *ngSwitchCase="'reject'">
        <div class="modal-header">
          <h3>Lý do từ chối xe: {{ selectedCar()?.Hang_xe }} {{ selectedCar()?.Dong_xe }} {{ selectedCar()?.Nam_san_xuat
            }}</h3>
        </div>
        <div class="modal-body">
          <p>Vui lòng nhập lý do từ chối. Người dùng sẽ thấy thông báo này.</p>
          <textarea class="form-control" rows="5" placeholder="Nhập lý do..." [value]="rejectionReason()"
            (input)="onReasonChange($event)"></textarea>
        </div>
        <div class="modal-footer">
          <button (click)="submitRejection()" class="btn btn-outline-danger">Xác nhận từ chối</button>
        </div>
      </div>

    </div>
  </div>
</div>